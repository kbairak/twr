-- =============================================================================
-- COMBINED VIEWS: Cache + Delta Pattern (Jinja2 Template)
-- =============================================================================
-- This migration creates the user-facing combined views that implement
-- the cache + delta pattern for each granularity:
-- - Query cached data (fast)
-- - UNION with fresh data after watermark (accurate)
-- =============================================================================

{% for g in GRANULARITIES %}
-- =============================================================================
-- {{ g.suffix }} GRANULARITY COMBINED VIEWS
-- =============================================================================

-- Combined timeline view ({{ g.suffix }} granularity): Cached data UNION new delta
-- This is the main view users should query for {{ g.suffix }} precision
-- It combines pre-computed cached data with freshly computed delta
CREATE VIEW user_product_timeline_{{ g.suffix }} AS
WITH cached AS (
    SELECT *, TRUE as is_cached
    FROM user_product_timeline_cache_{{ g.suffix }}
),
delta AS (
    -- Only compute events after the last cached timestamp (uses timestamp index for fast MAX lookup)
    SELECT *, FALSE as is_cached
    FROM user_product_timeline_base_{{ g.suffix }}
    WHERE timestamp > COALESCE((SELECT MAX(timestamp) FROM user_product_timeline_cache_{{ g.suffix }}), '1970-01-01'::TIMESTAMPTZ)
)
SELECT * FROM cached
UNION ALL
SELECT * FROM delta
ORDER BY user_id, product_id, timestamp;

-- Combined user timeline ({{ g.suffix }} granularity): Cached data UNION new delta
-- This is the main view users should query for user-level aggregated data
CREATE VIEW user_timeline_{{ g.suffix }} AS
WITH cached AS (
    SELECT *, TRUE as is_cached
    FROM user_timeline_cache_{{ g.suffix }}
),
delta AS (
    -- Only compute events after the last cached timestamp (uses timestamp index for fast MAX lookup)
    SELECT *, FALSE as is_cached
    FROM user_timeline_base_{{ g.suffix }}
    WHERE timestamp > COALESCE((SELECT MAX(timestamp) FROM user_timeline_cache_{{ g.suffix }}), '1970-01-01'::TIMESTAMPTZ)
)
SELECT * FROM cached
UNION ALL
SELECT * FROM delta
ORDER BY user_id, timestamp;

{% endfor %}
