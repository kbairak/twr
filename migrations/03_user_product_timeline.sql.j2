{% for g in GRANULARITIES %}

    CREATE TABLE user_product_timeline_cache_{{ g.suffix }} (
        -- Denormalized fields for efficient querying
        user_id UUID NOT NULL,
        product_id UUID NOT NULL,
        "timestamp" TIMESTAMPTZ NOT NULL,

        -- Portfolio state (all cumulative fields from cumulative_cashflow)
        deposits NUMERIC(20, 6),
        withdrawals NUMERIC(20, 6),
        buy_units NUMERIC(20, 6),
        sell_units NUMERIC(20, 6),
        buy_cost NUMERIC(20, 6),
        sell_proceeds NUMERIC(20, 6),

        -- Market data
        market_value NUMERIC(20, 6),  -- units Ã— market_price

        PRIMARY KEY (user_id, product_id, "timestamp")

      -- Derived fields (computed in Python):
      -- units = buy_units - sell_units
      -- net_investment = deposits - withdrawals
      -- fees = net_investment - (buy_cost - sell_proceeds)
      -- avg_buy_price = buy_cost / buy_units
      -- avg_sell_price = sell_proceeds / sell_units
    );

    CREATE INDEX idx_user_product_timeline_cache_{{ g.suffix }}_user_product
        ON user_product_timeline_cache_{{ g.suffix }}(user_id, product_id, "timestamp" DESC);
    CREATE INDEX idx_user_product_timeline_cache_{{ g.suffix }}_timestamp
        ON user_product_timeline_cache_{{ g.suffix }}("timestamp" DESC);

{% endfor %}
