{% for g in GRANULARITIES %}

    CREATE TABLE user_product_timeline_cache_{{ g.suffix }} (
        -- Denormalized fields for efficient querying
        user_id UUID NOT NULL,
        product_id UUID NOT NULL,
        "timestamp" TIMESTAMPTZ NOT NULL,

        -- Portfolio state (all cumulative fields from cumulative_cashflow)
        units_held NUMERIC(20, 6),
        net_investment NUMERIC(20, 6),
        deposits NUMERIC(20, 6),
        withdrawals NUMERIC(20, 6),
        fees NUMERIC(20, 6),
        buy_units NUMERIC(20, 6),
        sell_units NUMERIC(20, 6),
        buy_cost NUMERIC(20, 6),
        sell_proceeds NUMERIC(20, 6),

        -- Market data
        market_value NUMERIC(20, 6),  -- units_held Ã— market_price

        PRIMARY KEY (user_id, product_id, "timestamp")
    );

    CREATE INDEX idx_user_product_timeline_cache_{{ g.suffix }}_user_product
        ON user_product_timeline_cache_{{ g.suffix }}(user_id, product_id, "timestamp" DESC);
    CREATE INDEX idx_user_product_timeline_cache_{{ g.suffix }}_timestamp
        ON user_product_timeline_cache_{{ g.suffix }}("timestamp" DESC);

{% endfor %}
