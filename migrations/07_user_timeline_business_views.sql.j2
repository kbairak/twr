{% from '05_user_product_timeline.sql.j2' import user_product_timeline %}
{% from '06_user_product_timeline_business_views.sql.j2' import user_product_timeline_business, user_product_timeline_latest %}

{% macro user_timestamps(g) %}
    SELECT DISTINCT user_id, "timestamp"
    FROM ({{ user_product_timeline(g) }}) upt
    ORDER BY "timestamp" DESC
{% endmacro %}

{% macro user_timeline_business(g) %}
    SELECT
        ut.user_id,
        ut."timestamp",
        SUM(uptb.deposits) AS deposits,
        SUM(uptb.withdrawals) AS withdrawals,
        SUM(uptb.buy_cost) AS buy_cost,
        SUM(uptb.sell_proceeds) AS sell_proceeds,
        SUM(uptb.buy_units) AS buy_units,
        SUM(uptb.sell_units) AS sell_units,
        SUM(uptb.net_investment) AS net_investment,
        SUM(uptb.fees) AS fees,
        SUM(uptb.buy_cost) / NULLIF(SUM(uptb.buy_units), 0) AS avg_buy_cost,
        SUM(uptb.market_value) AS market_value,
        SUM(uptb.cost_basis) AS cost_basis,
        SUM(uptb.unrealized_returns) AS unrealized_returns
    FROM ({{ user_timestamps(g) }}) ut
        INNER JOIN LATERAL (
            SELECT DISTINCT ON (uptb.user_id, uptb.product_id)
                deposits, withdrawals, buy_cost, sell_proceeds, buy_units, sell_units,
                net_investment, fees, market_value, cost_basis, unrealized_returns
            FROM ({{ user_product_timeline_business(g) }}) uptb
            WHERE uptb.user_id = ut.user_id AND uptb."timestamp" <= ut."timestamp"
            ORDER BY uptb.user_id, uptb.product_id, uptb."timestamp" DESC
        ) uptb ON true
    GROUP BY ut.user_id, ut."timestamp"
{% endmacro %}

{% for g in GRANULARITIES %}
    CREATE VIEW user_timeline_business_{{ g.suffix }} AS {{ user_timeline_business(g) }};
{% endfor %}

{% macro user_timeline_latest() %}
    SELECT
        user_id,
        MAX("timestamp") as "timestamp",
        SUM(deposits) AS deposits,
        SUM(withdrawals) AS withdrawals,
        SUM(buy_cost) AS buy_cost,
        SUM(sell_proceeds) AS sell_proceeds,
        SUM(buy_units) AS buy_units,
        SUM(sell_units) AS sell_units,
        SUM(net_investment) AS net_investment,
        SUM(fees) AS fees,
        SUM(buy_cost) / NULLIF(SUM(buy_units), 0) AS avg_buy_cost,
        SUM(market_value) AS market_value,
        SUM(cost_basis) AS cost_basis,
        SUM(unrealized_returns) AS unrealized_returns
    FROM ({{ user_product_timeline_latest() }})
    GROUP BY user_id
{% endmacro %}

CREATE VIEW user_timeline_latest AS {{ user_timeline_latest() }};
