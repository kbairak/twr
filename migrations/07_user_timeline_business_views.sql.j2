{% for g in GRANULARITIES %}

    CREATE FUNCTION user_timestamps_{{ g.suffix }}(p_user_id UUID)
        RETURNS TABLE(user_id UUID, "timestamp" TIMESTAMPTZ)
        LANGUAGE plpgsql STABLE AS $$
        BEGIN
            {% macro query(w) %}
                RETURN QUERY
                SELECT DISTINCT upt.user_id, upt."timestamp"
                FROM user_product_timeline_{{ g.suffix }}(p_user_id, NULL) upt
                {{ w }}
                ORDER BY upt."timestamp" DESC
            {% endmacro %}
            IF p_user_id IS NULL THEN
                {{ query('') }};
            ELSE
                {{ query('WHERE upt.user_id = p_user_id') }};
            END IF;
        END;
        $$;

    CREATE FUNCTION user_timeline_business_{{ g.suffix }}(p_user_id UUID)
        RETURNS TABLE(
            user_id UUID, "timestamp" TIMESTAMPTZ, deposits NUMERIC(20, 6),
            withdrawals NUMERIC(20, 6), buy_cost NUMERIC(20, 6), sell_proceeds NUMERIC(20, 6),
            buy_units NUMERIC(20, 6), sell_units NUMERIC(20, 6), net_investment NUMERIC(20, 6),
            fees NUMERIC(20, 6), avg_buy_cost NUMERIC(20, 6), market_value NUMERIC(20, 6),
            cost_basis NUMERIC(20, 6), unrealized_returns NUMERIC(20, 6)
        )
        LANGUAGE plpgsql STABLE AS $$
        BEGIN
            {% macro query(w) %}
                RETURN QUERY
                SELECT
                    ut.user_id, ut."timestamp", SUM(uptb.deposits) AS deposits,
                    SUM(uptb.withdrawals) AS withdrawals, SUM(uptb.buy_cost) AS buy_cost,
                    SUM(uptb.sell_proceeds) AS sell_proceeds, SUM(uptb.buy_units) AS buy_units,
                    SUM(uptb.sell_units) AS sell_units, SUM(uptb.net_investment) AS net_investment,
                    SUM(uptb.fees) AS fees,
                    SUM(uptb.buy_cost) / NULLIF(SUM(uptb.buy_units), 0) AS avg_buy_cost,
                    SUM(uptb.market_value) AS market_value, SUM(uptb.cost_basis) AS cost_basis,
                    SUM(uptb.unrealized_returns) AS unrealized_returns
                FROM user_timestamps_{{ g.suffix }}(p_user_id) ut
                    INNER JOIN LATERAL (
                        SELECT DISTINCT ON (uptb.user_id, uptb.product_id)
                            uptb.deposits, uptb.withdrawals, uptb.buy_cost, uptb.sell_proceeds,
                            uptb.buy_units, uptb.sell_units, uptb.net_investment, uptb.fees,
                            uptb.market_value, uptb.cost_basis, uptb.unrealized_returns
                        FROM user_product_timeline_business_{{ g.suffix }}(p_user_id, NULL) uptb
                        WHERE uptb.user_id = ut.user_id AND uptb."timestamp" <= ut."timestamp"
                        ORDER BY uptb.user_id, uptb.product_id, uptb."timestamp" DESC
                    ) uptb ON true
                {{ w }}
                GROUP BY ut.user_id, ut."timestamp"
            {% endmacro %}
            IF p_user_id IS NULL THEN
                {{ query('') }};
            ELSE
                {{ query('WHERE ut.user_id = p_user_id') }};
            END IF;
        END;
        $$;

{% endfor %}

CREATE FUNCTION user_timeline_latest(p_user_id UUID)
    RETURNS TABLE(
        user_id UUID, "timestamp" TIMESTAMPTZ, deposits NUMERIC(20, 6), withdrawals NUMERIC(20, 6),
        buy_cost NUMERIC(20, 6), sell_proceeds NUMERIC(20, 6), buy_units NUMERIC(20, 6),
        sell_units NUMERIC(20, 6), net_investment NUMERIC(20, 6), fees NUMERIC(20, 6),
        avg_buy_cost NUMERIC(20, 6), market_value NUMERIC(20, 6), cost_basis NUMERIC(20, 6),
        unrealized_returns NUMERIC(20, 6)
    )
    LANGUAGE plpgsql STABLE AS $$
    BEGIN
        {% macro query(w) %}
            RETURN QUERY
            SELECT
                uptl.user_id, MAX(uptl."timestamp") as "timestamp", SUM(uptl.deposits) AS deposits,
                SUM(uptl.withdrawals) AS withdrawals, SUM(uptl.buy_cost) AS buy_cost,
                SUM(uptl.sell_proceeds) AS sell_proceeds, SUM(uptl.buy_units) AS buy_units,
                SUM(uptl.sell_units) AS sell_units, SUM(uptl.net_investment) AS net_investment,
                SUM(uptl.fees) AS fees,
                SUM(uptl.buy_cost) / NULLIF(SUM(uptl.buy_units), 0) AS avg_buy_cost,
                SUM(uptl.market_value) AS market_value, SUM(uptl.cost_basis) AS cost_basis,
                SUM(uptl.unrealized_returns) AS unrealized_returns
            FROM user_product_timeline_latest(p_user_id, NULL) uptl
            {{ w }}
            GROUP BY uptl.user_id
        {% endmacro %}
        IF p_user_id IS NULL THEN
            {{ query('') }};
        ELSE
            {{ query('WHERE uptl.user_id = p_user_id') }};
        END IF;
    END;
    $$;
