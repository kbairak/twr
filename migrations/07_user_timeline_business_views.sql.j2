{% for g in GRANULARITIES %}

    CREATE FUNCTION user_timestamps_{{ g.suffix }}(p_user_id UUID)
        RETURNS TABLE(user_id UUID, "timestamp" TIMESTAMPTZ)
        LANGUAGE plpgsql STABLE AS $$
        BEGIN
            {% macro query(w='') %}
                RETURN QUERY
                SELECT DISTINCT upt.user_id, upt."timestamp"
                FROM user_product_timeline_{{ g.suffix }}(p_user_id, NULL) upt
                {{ w }}
                ORDER BY upt."timestamp" DESC
            {% endmacro %}
            IF p_user_id IS NULL THEN
                {{ query() }};
            ELSE
                {{ query('WHERE upt.user_id = p_user_id') }};
            END IF;
        END;
        $$;

    CREATE FUNCTION user_timeline_business_{{ g.suffix }}(p_user_id UUID)
        RETURNS TABLE(
            user_id UUID, "timestamp" TIMESTAMPTZ, deposits NUMERIC(20, 6),
            withdrawals NUMERIC(20, 6), buy_cost NUMERIC(20, 6), sell_proceeds NUMERIC(20, 6),
            buy_units NUMERIC(20, 6), sell_units NUMERIC(20, 6), net_investment NUMERIC(20, 6),
            fees NUMERIC(20, 6), avg_buy_cost NUMERIC(20, 6), market_value NUMERIC(20, 6),
            cost_basis NUMERIC(20, 6), unrealized_returns NUMERIC(20, 6)
        )
        LANGUAGE plpgsql STABLE AS $$
        BEGIN
            RETURN QUERY
            SELECT
                ut.user_id, ut."timestamp",
                SUM(uptb.deposits) AS deposits,
                SUM(uptb.withdrawals) AS withdrawals,
                SUM(uptb.buy_cost) AS buy_cost,
                SUM(uptb.sell_proceeds) AS sell_proceeds,
                SUM(uptb.buy_units) AS buy_units,
                SUM(uptb.sell_units) AS sell_units,
                SUM(uptb.net_investment) AS net_investment,
                SUM(uptb.fees) AS fees,
                SUM(uptb.buy_cost) / NULLIF(SUM(uptb.buy_units), 0) AS avg_buy_cost,
                SUM(uptb.market_value) AS market_value,
                SUM(uptb.cost_basis) AS cost_basis,
                SUM(uptb.unrealized_returns) AS unrealized_returns
            FROM user_timestamps_{{ g.suffix }}(p_user_id) ut
                INNER JOIN LATERAL (
                    SELECT DISTINCT ON (upt.user_id, upt.product_id)
                        ccf.deposits, ccf.withdrawals, ccf.buy_cost, ccf.sell_proceeds,
                        ccf.buy_units, ccf.sell_units,
                        ccf.deposits - ccf.withdrawals AS net_investment,
                        ccf.deposits - ccf.buy_cost + ccf.withdrawals - ccf.sell_proceeds AS fees,
                        (ccf.buy_units - ccf.sell_units) * pu.price AS market_value,
                        (ccf.buy_units - ccf.sell_units) *
                            (ccf.buy_cost / NULLIF(ccf.buy_units, 0))
                            AS cost_basis,
                        (ccf.buy_units - ccf.sell_units) *
                            (pu.price - (ccf.buy_cost / NULLIF(ccf.buy_units, 0)))
                            AS unrealized_returns
                    FROM user_product_timeline_{{ g.suffix }}(p_user_id, NULL) upt
                        INNER JOIN price_update_{{ g.suffix }} pu ON
                            upt.product_id = pu.product_id AND upt."timestamp" = pu."timestamp"
                        INNER JOIN cumulative_cashflow(p_user_id, NULL) ccf ON
                            upt.user_id = ccf.user_id AND
                            upt.product_id = ccf.product_id AND
                            upt.cashflow_timestamp = ccf."timestamp"
                    WHERE upt.user_id = ut.user_id AND upt."timestamp" <= ut."timestamp"
                    ORDER BY upt.user_id, upt.product_id, upt."timestamp" DESC
                ) uptb ON true
            WHERE ut.user_id = p_user_id
            GROUP BY ut.user_id, ut."timestamp";
        END;
        $$;

{% endfor %}

CREATE FUNCTION user_timeline_latest(p_user_id UUID)
    RETURNS TABLE(
        user_id UUID, "timestamp" TIMESTAMPTZ, deposits NUMERIC(20, 6), withdrawals NUMERIC(20, 6),
        buy_cost NUMERIC(20, 6), sell_proceeds NUMERIC(20, 6), buy_units NUMERIC(20, 6),
        sell_units NUMERIC(20, 6), net_investment NUMERIC(20, 6), fees NUMERIC(20, 6),
        avg_buy_cost NUMERIC(20, 6), market_value NUMERIC(20, 6), cost_basis NUMERIC(20, 6),
        unrealized_returns NUMERIC(20, 6)
    )
    LANGUAGE plpgsql STABLE AS $$
    BEGIN
        RETURN QUERY
        SELECT
            uptl.user_id,
            MAX(uptl."timestamp") as "timestamp",
            SUM(uptl.deposits) AS deposits,
            SUM(uptl.withdrawals) AS withdrawals,
            SUM(uptl.buy_cost) AS buy_cost,
            SUM(uptl.sell_proceeds) AS sell_proceeds,
            SUM(uptl.buy_units) AS buy_units,
            SUM(uptl.sell_units) AS sell_units,
            SUM(uptl.net_investment) AS net_investment,
            SUM(uptl.fees) AS fees,
            SUM(uptl.buy_cost) / NULLIF(SUM(uptl.buy_units), 0) AS avg_buy_cost,
            SUM(uptl.market_value) AS market_value,
            SUM(uptl.cost_basis) AS cost_basis,
            SUM(uptl.unrealized_returns) AS unrealized_returns
        FROM user_product_timeline_latest(p_user_id, NULL) uptl
        WHERE uptl.user_id = p_user_id
        GROUP BY uptl.user_id;
    END;
    $$;
