{% for g in GRANULARITIES %}

    -- user_product_timeline_business_{{ g.suffix }}: Returns complete business metrics timeline
    --
    -- Purpose: Main business query interface combining timeline, prices, and cashflows
    -- Returns: Full timeline with all computed business metrics:
    --   - Raw cashflow totals: buy_units, sell_units, buy_cost, sell_proceeds, deposits, withdrawals
    --   - Derived metrics: units (current holdings), net_investment, fees
    --   - Market metrics: market_value (units * price), avg_buy_cost, cost_basis
    --   - Performance: unrealized_returns (market_value - cost_basis)
    -- Performance: Joins cached timeline with prices and cashflows
    -- Parameters:
    --   - p_user_id: Required - specific user to query
    --   - p_product_id: Filter by product (NULL = all products)
    CREATE OR REPLACE FUNCTION user_product_timeline_business_{{ g.suffix }}(
            p_user_id UUID, p_product_id UUID DEFAULT NULL
        )
        RETURNS TABLE(
            user_id UUID, product_id UUID, "timestamp" TIMESTAMPTZ, buy_units NUMERIC(20, 6),
            sell_units NUMERIC(20, 6), buy_cost NUMERIC(20, 6), sell_proceeds NUMERIC(20, 6),
            deposits NUMERIC(20, 6), withdrawals NUMERIC(20, 6), units NUMERIC(20, 6),
            net_investment NUMERIC(20, 6), fees NUMERIC(20, 6), price NUMERIC(20, 6),
            market_value NUMERIC(20, 6), avg_buy_cost NUMERIC(20, 6), cost_basis NUMERIC(20, 6),
            unrealized_returns NUMERIC(20, 6)
        )
        LANGUAGE plpgsql STABLE AS $$
        DECLARE
            v_after TIMESTAMPTZ :=
                {% if g.cache_retention %}
                    NOW() - '{{ g.cache_retention }}'::interval
                {% else %}
                    NULL
                {% endif %};
        BEGIN
            RETURN QUERY
            SELECT
                upt.user_id, upt.product_id, upt."timestamp",
                ccf.buy_units, ccf.sell_units, ccf.buy_cost, ccf.sell_proceeds, ccf.deposits,
                ccf.withdrawals,
                ccf.buy_units - ccf.sell_units AS units,
                ccf.deposits - ccf.withdrawals AS net_investment,
                ccf.deposits - ccf.buy_cost + ccf.withdrawals - ccf.sell_proceeds AS fees,
                -- units * pu.price AS market_value
                pu.price,
                (ccf.buy_units - ccf.sell_units) * pu.price AS market_value,
                ccf.buy_cost / NULLIF(ccf.buy_units, 0) AS avg_buy_cost,
                -- units * avg_buy_cost AS cost_basis
                (ccf.buy_units - ccf.sell_units) *
                    (ccf.buy_cost / NULLIF(ccf.buy_units, 0))
                    AS cost_basis,
                -- market_value - cost_basis AS unrealized_returns or
                -- units * (market_price - avg_buy_cost) AS unrealized_returns
                (ccf.buy_units - ccf.sell_units) *
                    (pu.price - (ccf.buy_cost / NULLIF(ccf.buy_units, 0)))
                    AS unrealized_returns
            FROM user_product_timeline_{{ g.suffix }}(p_user_id, p_product_id, v_after, NULL) upt
                INNER JOIN price_update_{{ g.suffix }} pu ON
                    upt.product_id = pu.product_id AND upt."timestamp" = pu."timestamp"
                INNER JOIN cumulative_cashflow(p_user_id, p_product_id) ccf ON
                    upt.user_id = ccf.user_id AND
                    upt.product_id = ccf.product_id AND
                    upt.cashflow_timestamp = ccf."timestamp"
            ORDER BY upt.user_id, upt.product_id, upt."timestamp";
        END;
        $$;

{% endfor %}

-- user_product_timeline_latest: Returns the most recent business metrics (real-time)
--
-- Purpose: Fast query for current portfolio position without granularity bucketing
-- Returns: Single row with latest business metrics using raw price_update table
-- Performance: Uses DISTINCT ON to get latest cashflow and price - very fast
-- Parameters:
--   - p_user_id: Required - specific user to query
--   - p_product_id: Required - specific product to query
-- Note: Uses price_update base table (not bucketed) for maximum freshness
CREATE OR REPLACE FUNCTION user_product_timeline_latest(p_user_id UUID, p_product_id UUID)
    RETURNS TABLE(
        user_id UUID, product_id UUID, "timestamp" TIMESTAMPTZ, buy_units NUMERIC(20, 6),
        sell_units NUMERIC(20, 6), buy_cost NUMERIC(20, 6), sell_proceeds NUMERIC(20, 6),
        deposits NUMERIC(20, 6), withdrawals NUMERIC(20, 6), units NUMERIC(20, 6),
        net_investment NUMERIC(20, 6), fees NUMERIC(20, 6), price NUMERIC(20, 6),
        market_value NUMERIC(20, 6), avg_buy_cost NUMERIC(20, 6), cost_basis NUMERIC(20, 6),
        unrealized_returns NUMERIC(20, 6)
    )
    LANGUAGE plpgsql STABLE AS $$
    BEGIN
        RETURN QUERY
        SELECT
            ccf.user_id, ccf.product_id,
            GREATEST(ccf."timestamp", pu."timestamp") as "timestamp",
            ccf.buy_units, ccf.sell_units, ccf.buy_cost, ccf.sell_proceeds, ccf.deposits,
            ccf.withdrawals,
            ccf.buy_units - ccf.sell_units AS units,
            ccf.deposits - ccf.withdrawals AS net_investment,
            ccf.deposits - ccf.buy_cost + ccf.withdrawals - ccf.sell_proceeds AS fees,
            pu.price,
            (ccf.buy_units - ccf.sell_units) * pu.price AS market_value,
            ccf.buy_cost / NULLIF(ccf.buy_units, 0) AS avg_buy_cost,
            (ccf.buy_units - ccf.sell_units) *
                (ccf.buy_cost / NULLIF(ccf.buy_units, 0))
                AS cost_basis,
            (ccf.buy_units - ccf.sell_units) *
                (pu.price - (ccf.buy_cost / NULLIF(ccf.buy_units, 0)))
                AS unrealized_returns
        FROM (
            SELECT DISTINCT ON (ccf.user_id, ccf.product_id)
                ccf.user_id, ccf.product_id, ccf."timestamp", ccf.buy_units, ccf.sell_units,
                ccf.buy_cost, ccf.sell_proceeds, ccf.deposits, ccf.withdrawals
            FROM cumulative_cashflow(p_user_id, p_product_id) ccf
            WHERE ccf.user_id = p_user_id AND ccf.product_id = p_product_id
            ORDER BY ccf.user_id, ccf.product_id, ccf."timestamp" DESC
        ) ccf
            INNER JOIN (
                SELECT DISTINCT ON (pu.product_id) pu.product_id, pu."timestamp", pu.price
                FROM price_update pu
                ORDER BY pu.product_id, pu."timestamp" DESC
            ) pu ON ccf.product_id = pu.product_id;
    END;
    $$;
