{% for g in GRANULARITIES %}

    CREATE TABLE user_timeline_cache_{{ g.suffix }} (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

        -- Denormalized fields for efficient querying
        user_id UUID NOT NULL,
        "timestamp" TIMESTAMPTZ NOT NULL,

        -- Portfolio-level aggregates (SUM across all products)
        market_value NUMERIC(20, 6),

        -- Aggregated cumulative fields
        deposits NUMERIC(20, 6),
        withdrawals NUMERIC(20, 6),
        buy_cost NUMERIC(20, 6),
        sell_proceeds NUMERIC(20, 6),
        cost_basis NUMERIC(20, 6),
        sell_basis NUMERIC(20, 6),

        CONSTRAINT unique_user_timeline_{{ g.suffix }} UNIQUE (user_id, "timestamp")
    );

    CREATE INDEX idx_user_timeline_cache_{{ g.suffix }}_user
        ON user_timeline_cache_{{ g.suffix }}(user_id, "timestamp" DESC);
    CREATE INDEX idx_user_timeline_cache_{{ g.suffix }}_timestamp
        ON user_timeline_cache_{{ g.suffix }}("timestamp" DESC);

{% endfor %}
